# Import base_config from git
import_from_git(url: 'https://github.com/rakutentech/ios-buildconfig.git')

default_platform(:ios)

platform :ios do
  desc "Project update"
  lane :updatePods do |options|
    git_submodule_update
    cocoapods(repo_update: ENV['MA_FL_CP_REPO_UPDATE'] || false)
  end

  desc "Build All"
  lane :ci do |options|
    xcversion(version: "~> 12.0")

    swiftlint(
      strict: true,
      ignore_exit_status: false
    )

    updatePods

    scan(
      clean: true,
      output_directory: './artifacts/unit-tests',
      scheme: 'MiniApp_Tests',
      device: 'iPhone X',
      code_coverage: true,
      output_types: 'json-compilation-database,html,junit',
      output_files: 'compile_commands.json,report.html,report.junit')

    if is_ci?
      puts "Running on CI, coverage report will be generated by Danger"
    else
      puts "Running locally so call coverage lane"
      coverage
    end
  end

  lane :build_simulator do |options|
    xcversion(version: "~> 12.0")

    updatePods

    xcodebuild(
      workspace: "MiniApp.xcworkspace",
      scheme: "MiniApp-Example",
      xcargs: "-configuration Debug -sdk 'iphonesimulator' -destination 'generic/platform=iOS Simulator' -derivedDataPath 'artifacts/derivedData'"
    )

    copy_artifacts(
      target_path: "artifacts",
      artifacts: ["./artifacts/derivedData/Build/Products/Debug-iphonesimulator/MiniApp_Example.app"]
    )

  end

  desc "Generate code coverage"
  lane :coverage do |options|
    Dir.chdir("..") do
      sh("bundle exec danger dry_run")
    end
  end
end
